<!DOCTYPE html>
<html>
<head>
<title>FF Tournament Entry</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{margin:0;background:#0d0d0d;color:#fff;font-family:Arial}
.container{max-width:420px;margin:20px auto;padding:20px;background:#151515;border-radius:12px}
select,input,button{width:100%;padding:12px;margin:8px 0;border-radius:8px;border:none}
button{background:#00ff88;font-weight:bold;cursor:pointer}
.playerBox{background:#1f1f1f;padding:10px;border-radius:8px;margin-top:10px}
.hidden{display:none}
.success{color:#00ff88;text-align:center}
.error{color:red;text-align:center}
</style>
</head>
<body>
<div class="container">

<!-- PAGE 1 -->
<div id="page1">
  <h2>Select Mode</h2>
  <select id="mode">
    <option value="solo">Solo - ₹10</option>
    <option value="duo">Duo - ₹20</option>
    <option value="squad">Squad - ₹40</option>
  </select>
  <div id="players"></div>
  <button onclick="goPayment()">Next</button>

  <!-- SINGLE ROUND IMAGE ADDED -->
  <div style="text-align:center; margin-top:15px;">
    <img src="https://grim-tomato-b5lyfgp6av.edgeone.app/1000073411-Picsart-AiImageEnhancer.png.jpg"
         style="width:100px; height:100px; border-radius:50%; border:3px solid #00ff88;">
  </div>
</div>

<!-- PAGE 2 -->
<div id="page2" class="hidden">
  <h2>Pay Now</h2>
  <img id="qr" width="200">
  <button id="payBtn">Open UPI App</button>
  <button onclick="goTransaction()">Payment Done</button>
</div>

<!-- PAGE 3 -->
<div id="page3" class="hidden">
  <h2>Enter Transaction ID</h2>
  <input type="text" id="txn" placeholder="Transaction ID">
  <button onclick="submitEntry()">Submit</button>
</div>

<!-- PAGE 4 -->
<div id="page4" class="hidden">
  <h2>Room Player List</h2>
  <div id="playerList"></div>
</div>

<div id="message"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, query, where, serverTimestamp } 
from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig = {
apiKey: "AIzaSyBu8NUAAiT61yfFUhwqoQMDSaH_x891oZk",
authDomain: "ff-tunamatch.firebaseapp.com",
projectId: "ff-tunamatch"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const upiID="7762067909@naviaxis";

const modeSelect=document.getElementById("mode");
const playersDiv=document.getElementById("players");
const messageDiv=document.getElementById("message");

function getAmount(){
return modeSelect.value==="solo"?10:
modeSelect.value==="duo"?20:40;
}

function renderPlayers(){
let count=modeSelect.value==="solo"?1:
modeSelect.value==="duo"?2:4;
playersDiv.innerHTML="";
for(let i=1;i<=count;i++){
playersDiv.innerHTML+=`
<div class="playerBox">
<h4>Player ${i}</h4>
<input type="text" id="name${i}" placeholder="Name">
<input type="text" id="uid${i}" placeholder="UID">
</div>`;
}
generateQR();
}

modeSelect.addEventListener("change",renderPlayers);
renderPlayers();

function generateQR(){
let amount=getAmount();
let upiLink=`upi://pay?pa=${upiID}&pn=FF Tournament&am=${amount}&cu=INR`;
document.getElementById("qr").src=
"https://api.qrserver.com/v1/create-qr-code/?size=200x200&data="+encodeURIComponent(upiLink);
document.getElementById("payBtn").onclick=function(){
window.open(upiLink,"_self");
}
}

window.goPayment=function(){
document.getElementById("page1").classList.add("hidden");
document.getElementById("page2").classList.remove("hidden");
}

window.goTransaction=function(){
document.getElementById("page2").classList.add("hidden");
document.getElementById("page3").classList.remove("hidden");
}

async function getLatestRoom(mode){
let roomsRef=collection(db,"rooms");
let q=query(roomsRef,where("mode","==",mode),where("status","==","open"));
let snap=await getDocs(q);
let room=null;
let maxNum=0;

snap.forEach(doc=>{
let data=doc.data();
let playerCount=data.currentPlayers||0;
if(playerCount<20 && data.roomNumber>maxNum){
room={id:doc.id,...data};
maxNum=data.roomNumber;
}
});
if(room) return room;

// agar koi room nahi ya full → naya create
let newRoomNumber=maxNum+1 || 1;
let password=Math.floor(1000+Math.random()*9000).toString();

let docRef=await addDoc(collection(db,"rooms"),{
roomId:"room"+newRoomNumber,
roomNumber:newRoomNumber,
password:password,
mode:mode,
status:"open",
currentPlayers:0,
maxPlayers:20
});
return {id:docRef.id,roomId:"room"+newRoomNumber,roomNumber:newRoomNumber,password,password,mode:mode,status:"open",currentPlayers:0,maxPlayers:20};
}

window.submitEntry=async function(){
let txn=document.getElementById("txn").value.trim();
if(!txn) return showError("Enter Transaction ID");

let count=modeSelect.value==="solo"?1:
modeSelect.value==="duo"?2:4;

let players=[];
let uniqueUIDs=new Set();

for(let i=1;i<=count;i++){
let name=document.getElementById("name"+i).value.trim();
let uid=document.getElementById("uid"+i).value.trim();
if(!name||!uid) return showError("Fill all details");
if(uniqueUIDs.has(uid)) return showError("Duplicate UID not allowed");
uniqueUIDs.add(uid);
players.push({name,uid});
}

let room=await getLatestRoom(modeSelect.value);

// save entry
await addDoc(collection(db,"entries"),{
roomId:room.roomId,
mode:modeSelect.value,
players,
transactionId:txn,
amount:getAmount(),
createdAt:serverTimestamp()
});

// update room player count
let roomRef=collection(db,"rooms");
let roomDoc=await getDocs(query(roomRef,where("roomId","==",room.roomId)));
roomDoc.forEach(async d=>{
let data=d.data();
await addDoc(collection(db,"rooms"),{currentPlayers:(data.currentPlayers||0)+count});
});

loadRoom(room.roomId);
document.getElementById("page3").classList.add("hidden");
document.getElementById("page4").classList.remove("hidden");
messageDiv.innerHTML="<div class='success'>Entry Submitted</div>";
}

async function loadRoom(roomId){
let q=query(collection(db,"entries"),where("roomId","==",roomId));
let snap=await getDocs(q);
let html="<h3>Players</h3>";
let i=1;
let shownUIDs=new Set();
snap.forEach(doc=>{
let data=doc.data();
data.players.forEach(p=>{
if(!shownUIDs.has(p.uid)){
html+=i+". "+p.name+" - "+p.uid+"<br>";
shownUIDs.add(p.uid);
i++;
}
});
});

// Room info load
let roomSnap=await getDocs(query(collection(db,"rooms"),where("roomId","==",roomId)));
roomSnap.forEach(doc=>{
let r=doc.data();
if(r.status==="open"){
html+=`<hr><h3>Room Details</h3>Room ID: ${r.roomNumber}<br>Password: ${r.password}`;
}else{
html+=`<hr><b>Room Not Open Yet</b>`;
}
});

document.getElementById("playerList").innerHTML=html;
}

function showError(msg){
messageDiv.innerHTML="<div class='error'>"+msg+"</div>";
}

</script>
</body>
</html>